{"version":3,"file":"PageDocumentExchange-1604fbb0.js","sources":["../../src/views/transaction/PageRCUReport/PageDocumentExchange/PageDocumentExchange.tsx"],"sourcesContent":["import { Column, EditableComponentRef } from \"components/EditableTableV2/EditableTableV2\";\nimport ErrorDialog from \"components/ErrorDialog/ErrorDialog\";\nimport FileUploadBox from \"components/FileUploadBox/FileUploadBox\";\nimport IconButton from \"components/IconButton/IconButton\";\nimport Info from \"components/Info/Info\";\nimport ReadOnlyTable from \"components/ReadOnlyTable/ReadOnlyTable\";\nimport Section from \"components/Section/Section\";\nimport Text from \"components/Text/Text\";\nimport React, { useEffect, useState } from \"react\";\nimport { useParams } from \"react-router-dom\";\nimport FileUploadService from \"services/FileUploadService\";\nimport LegalService from \"services/transaction/DDE/LegalService\";\nimport RcuService from \"services/transaction/DDE/RcuService\";\nimport { formatDate, parseStandardAPIErrorMessage } from \"utils/CommonUtil\";\nimport {\n  DOCUMENT_CATEGORY,\n  DOCUMENT_SECTION,\n  LOAN_SECTION_KEY,\n  MONTHS,\n  VARIANTS,\n} from \"utils/Constant\";\n\ninterface IPageObj {\n  showInfo: boolean;\n  stageUid: string;\n}\n\nconst initialPageOj: IPageObj = {\n  showInfo: true,\n  stageUid: \"\",\n};\n\ninterface IRowData {\n  uid: string;\n  createdByUserName: string;\n  updatedAt: string;\n  documentSections: {\n    uid: string;\n    fileName: string;\n    fileType: string;\n    thumbUrl: string;\n    url: string;\n  }[];\n}\n\nconst initialTableRowObj = {\n  name: \"\",\n  createdAt: \"\",\n  isUploaded: false,\n  isAdded: true,\n  url: \"\",\n};\n\nconst PageDocumentExchange = () => {\n  const params: { loanUid?: string; stageUid?: string } = useParams();\n  /*\n    -------------------------------------------------------\n      State\n    -------------------------------------------------------\n    */\n\n  const [showDialogAPIError, setShowDialogAPIError] = useState(false);\n  const [errorMessage, setErrorMessage] = useState<any>(\"\");\n  const [pageObj, setPageObj] = useState<IPageObj>({ ...initialPageOj });\n\n  // ref\n  const tableRef = React.useRef<EditableComponentRef>(null);\n\n  // --------------------------- global variables ---------------------- //\n\n  /*\n     -------------------------------------------------------\n       useEffect\n     -------------------------------------------------------\n   */\n\n  useEffect(() => {\n    setPageObj((prevPageObj) => ({\n      ...prevPageObj,\n      stageUid: params?.stageUid ?? \"\",\n    }));\n  }, []);\n\n  useEffect(() => {\n    if (errorMessage) {\n      setShowDialogAPIError(true);\n    }\n  }, [errorMessage]);\n\n  /*\n    -------------------------------------------------------\n      Service Calls\n    -------------------------------------------------------\n  */\n\n  /*\n    -------------------------------------------------------\n      Handlers\n    -------------------------------------------------------\n  */\n  const onCloseInfo = () => {\n    setPageObj((prevPageObj) => ({ ...prevPageObj, showInfo: false }));\n  };\n\n  /* \n    --------------------------------------------------------\n    Validators:\n    --------------------------------------------------------\n  */\n\n  /*\n    -------------------------------------------------------\n      Button Click Handlers\n    -------------------------------------------------------\n  */\n  const onDeleteRow = async (rowData: any) => {\n    console.log(\"delete row data\");\n    try {\n      const payload = enrichForUpdate(rowData);\n      await LegalService.updateDocumentExchange(payload);\n      tableRef.current?.search();\n    } catch (error) {\n      console.log(error);\n      setErrorMessage(parseStandardAPIErrorMessage(error));\n    }\n  };\n\n  const onAddDocument = async (e: any) => {\n    const file = e.files[0];\n    // Generate a unique object name\n    const timestamp = new Date().getTime();\n    const randomString = Math.random().toString(36).substring(2, 8);\n    const fileNameSplit = file?.name?.split(\".\");\n    let fileNameWithoutExtension = \"\";\n    if (fileNameSplit?.length > 1) {\n      for (let i = 0; i < fileNameSplit.length - 1; i++) {\n        if (i === fileNameSplit.length - 1) {\n          break;\n        }\n        fileNameWithoutExtension += fileNameSplit[i];\n      }\n      const objectName = `${fileNameWithoutExtension}_${timestamp}_${randomString}.${\n        fileNameSplit[fileNameSplit.length - 1]\n      }`;\n\n      try {\n        const res = await FileUploadService.saveFile(file, objectName);\n        const payload = enrichForCreate(res.data);\n        await RcuService.updateDocumentExchange(payload);\n        tableRef.current?.search();\n      } catch (error) {\n        console.log(error);\n        setErrorMessage(parseStandardAPIErrorMessage(error));\n      }\n    }\n  };\n\n  const onDownloadDocument = async (rowData: IRowData) => {\n    const fileUrl = rowData?.documentSections?.[0]?.url;\n    const fileName = rowData?.documentSections?.[0]?.fileName;\n\n    // getSignedUrl\n    // downloadFileFromUrl\n    try {\n      const res = await FileUploadService.getSignedURL(fileUrl);\n\n      fetch(res.data?.SignedUrl)\n        .then((response) => {\n          if (!response.ok) {\n            throw new Error(\"Network response was not ok: \" + response.status);\n          }\n          return response.blob();\n        })\n        .then((blob) => {\n          const blobUrl = URL.createObjectURL(blob);\n          const downloadLink = document.createElement(\"a\");\n          downloadLink.href = blobUrl;\n          downloadLink.download = fileName;\n          document.body.appendChild(downloadLink);\n          downloadLink.click();\n          document.body.removeChild(downloadLink);\n          URL.revokeObjectURL(blobUrl);\n        })\n        .catch((error) => {\n          console.error(\"Error fetching the file:\", error);\n        });\n    } catch (error) {\n      setErrorMessage(parseStandardAPIErrorMessage(error));\n    }\n\n    // Fetch the file as a Blob\n  };\n\n  /*\n    -------------------------------------------------------\n      Helper Functions\n    -------------------------------------------------------\n  */\n\n  const enrichForCreate = (signedData: any) => {\n    const obj = {\n      docType: {\n        uid: \"a1f9c167-ecbb-461d-9b47-7b1efebc6a19\",\n      },\n      loanSectionKey: LOAN_SECTION_KEY.DOCUMENT_EXCHANGE,\n      docCategory: DOCUMENT_CATEGORY.DOCUMENT_CATEGORY_EXCHANGE_DOCUMENTS,\n      stage: {\n        uid: pageObj.stageUid,\n      },\n      loan: {\n        uid: params?.loanUid,\n      },\n      documentSections: [\n        {\n          section: DOCUMENT_SECTION.DOCUMENT_SECTIONS_FILE_1,\n          fileName: signedData?.fileName,\n          fileType: signedData?.contentType,\n          thumbUrl: signedData?.thumbUrl,\n          url: signedData?.url,\n        },\n      ],\n    };\n    return obj;\n  };\n\n  const enrichForUpdate = (data: IRowData) => {\n    const obj = {\n      uid: data?.uid,\n      docType: {\n        uid: \"a1f9c167-ecbb-461d-9b47-7b1efebc6a19\",\n      },\n      loanSectionKey: LOAN_SECTION_KEY.DOCUMENT_EXCHANGE,\n      docCategory: DOCUMENT_CATEGORY.DOCUMENT_CATEGORY_EXCHANGE_DOCUMENTS,\n      stage: {\n        uid: pageObj.stageUid,\n      },\n      loan: {\n        uid: params?.loanUid,\n      },\n      documentSections: [\n        {\n          uid: data?.documentSections?.[0]?.uid,\n          section: DOCUMENT_SECTION.DOCUMENT_SECTIONS_FILE_1,\n          fileName: data?.documentSections?.[0]?.fileName,\n          fileType: data?.documentSections?.[0]?.fileType,\n          thumbUrl: data?.documentSections?.[0]?.thumbUrl,\n          url: data?.documentSections?.[0]?.url,\n          isActive: false,\n        },\n      ],\n      isActive: false,\n    };\n    return obj;\n  };\n\n  /*\n    -------------------------------------------------------\n      Sectional Rendering\n    -------------------------------------------------------\n  */\n\n  const renderUser = (rowData: IRowData) => {\n    return <span>{rowData?.createdByUserName ?? \"\"}</span>;\n  };\n  const renderFileName = (rowData: IRowData) => {\n    return <span>{rowData?.documentSections?.[0].fileName}</span>;\n  };\n  const renderFileType = (rowData: IRowData) => {\n    return <span>{rowData?.documentSections?.[0].fileType ?? \"\"}</span>;\n  };\n  const renderUpdatedOn = (rowData: IRowData) => {\n    return <span>{formatDate(rowData?.updatedAt) ?? \"\"}</span>;\n  };\n  const renderAction = (rowData: IRowData) => {\n    return (\n      <div className=\"flex\">\n        <div className=\"mr-6\">\n          <IconButton\n            onClick={() => onDownloadDocument(rowData)}\n            buttonType={\"DOWNLOAD\"}\n            tooltipOptions={{\n              position: \"top\",\n              className: \"text-xs font-Roboto bg-black text-white !p-1 rounded-md \",\n              showDelay: \"1000,\",\n              hideDelay: \"300\",\n            }}\n          />\n        </div>\n        <div className=\"\">\n          <IconButton\n            onClick={() => onDeleteRow(rowData)}\n            buttonType={\"DELETE\"}\n            tooltipOptions={{\n              position: \"top\",\n              className: \"text-xs font-Roboto bg-black text-white !p-1 rounded-md \",\n              showDelay: \"1000,\",\n              hideDelay: \"300\",\n            }}\n          />\n        </div>\n      </div>\n    );\n  };\n  /*\n    -------------------------------------------------------\n    Main Rendering\n    -------------------------------------------------------\n  */\n  return (\n    <div className=\"grid gap-5 mb-5\">\n      {pageObj?.showInfo ? (\n        <Info description=\"description.legal.info\" onClose={onCloseInfo} />\n      ) : null}\n      <Section title=\"label.rcu.rcuDocumentExchange\">\n        <>\n          <div className=\"flex justify-end\">\n            \n            <div className=\" mr-3 self-center\">\n              <FileUploadBox label={\"Add\"} onSelect={onAddDocument} variant={VARIANTS.PRIMARY} />\n            </div>\n          </div>\n          {params?.loanUid && pageObj?.stageUid ? (\n            <ReadOnlyTable\n              ref={tableRef}\n              standardDataFormatPromise={RcuService.getDocumentExchangeList}\n              search={`&loanUid=${params.loanUid}&stageUid=${pageObj.stageUid}&loanSectionKey=${LOAN_SECTION_KEY.DOCUMENT_EXCHANGE}&isActive=true`}\n              dataKey=\"uid\"\n            >\n              <Column\n                className=\"text-primary-ptext-1000 text-left text-xs  p-1 h-12 pl-6\"\n                header={\"User\"}\n                body={renderUser}\n              />\n              <Column\n                className=\"text-primary-ptext-1000 text-left text-xs  p-1 h-12 pl-6\"\n                header={\"File Name\"}\n                body={renderFileName}\n              />\n              <Column\n                className=\"text-primary-ptext-1000 text-left text-xs  p-1 h-12 pl-6\"\n                header={\"File Type\"}\n                body={renderFileType}\n              />\n              <Column\n                className=\"text-primary-ptext-1000 text-left text-xs  p-1 h-12 pl-6\"\n                header={\"Updated On\"}\n                body={renderUpdatedOn}\n              />\n              <Column\n                className=\"text-primary-ptext-1000 text-left text-xs  p-1 h-12 pl-6\"\n                header={\"Actions\"}\n                body={renderAction}\n              />\n            </ReadOnlyTable>\n          ) : null}\n        </>\n      </Section>\n\n      <ErrorDialog\n        onHide={() => {\n          setShowDialogAPIError(false);\n          setErrorMessage(\"\");\n        }}\n        visible={showDialogAPIError}\n        errorMessage={errorMessage}\n      />\n    </div>\n  );\n};\n\nexport default PageDocumentExchange;\n"],"names":["initialPageOj","PageDocumentExchange","params","useParams","showDialogAPIError","setShowDialogAPIError","useState","errorMessage","setErrorMessage","pageObj","setPageObj","tableRef","React","useEffect","prevPageObj","onCloseInfo","onDeleteRow","rowData","payload","enrichForUpdate","LegalService","_a","error","parseStandardAPIErrorMessage","onAddDocument","file","timestamp","randomString","fileNameSplit","fileNameWithoutExtension","i","objectName","res","FileUploadService","enrichForCreate","RcuService","_b","onDownloadDocument","fileUrl","fileName","_d","_c","_e","response","blob","blobUrl","downloadLink","signedData","LOAN_SECTION_KEY","DOCUMENT_CATEGORY","DOCUMENT_SECTION","data","_f","_h","_g","_j","_i","renderUser","jsx","renderFileName","renderFileType","renderUpdatedOn","formatDate","renderAction","jsxs","IconButton","Info","Section","Fragment","FileUploadBox","VARIANTS","ReadOnlyTable","Column","ErrorDialog"],"mappings":"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"}